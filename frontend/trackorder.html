{% extends 'basic.html' %}
{% block title %}FreshMart India - Track Order{% endblock %}

{% block css %}
<style>
    main {
        padding: 4rem 0;
        min-height: calc(100vh - 300px);
    }

    h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: fadeIn 0.6s ease;
    }

    .order-id-subtitle {
        color: #6b7280;
        font-size: 1.125rem;
        margin-bottom: 3rem;
        animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    .track-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .track-card {
        background: linear-gradient(135deg, #111111 0%, #0a0a0a 100%);
        border: 1px solid #1f2937;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.5s ease-out;
    }

    .track-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: #10b981;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 3rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(180deg, #10b981 0%, #1f2937 100%);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
        animation: slideUp 0.6s ease-out;
    }

    .timeline-item:nth-child(2) { animation-delay: 0.1s; }
    .timeline-item:nth-child(3) { animation-delay: 0.2s; }
    .timeline-item:nth-child(4) { animation-delay: 0.3s; }
    .timeline-item:nth-child(5) { animation-delay: 0.4s; }

    .timeline-dot {
        position: absolute;
        left: -2.5rem;
        top: 0.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #1f2937;
        border: 2px solid #1f2937;
        transition: all 0.3s;
    }

    .timeline-item.completed .timeline-dot {
        background: #10b981;
        border-color: #10b981;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }

    .timeline-item.active .timeline-dot {
        background: #f59e0b;
        border-color: #f59e0b;
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        animation: pulse 2s infinite;
    }

    .timeline-content {
        padding-left: 1rem;
    }

    .timeline-title {
        font-weight: 700;
        font-size: 1.125rem;
        color: #ffffff;
        margin-bottom: 0.25rem;
    }

    .timeline-item.completed .timeline-title {
        color: #10b981;
    }

    .timeline-item.active .timeline-title {
        color: #f59e0b;
    }

    .timeline-date {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .timeline-description {
        color: #9ca3af;
        font-size: 0.875rem;
        line-height: 1.6;
    }

    /* Order Details */
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #1f2937;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: #6b7280;
        font-weight: 500;
    }

    .detail-value {
        color: #ffffff;
        font-weight: 600;
    }

    .order-items-list {
        margin-top: 1rem;
    }

    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        color: #9ca3af;
        font-size: 0.875rem;
        border-bottom: 1px solid #1f2937;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-total {
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        font-size: 1.25rem;
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 2px solid #10b981;
        color: #10b981;
    }

    .delivery-info {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
        border: 1px solid #10b981;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }

    .delivery-info h3 {
        color: #10b981;
        font-size: 1.125rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .delivery-info p {
        color: #9ca3af;
        line-height: 1.8;
        margin-bottom: 0.5rem;
    }

    .btn-back {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        color: #ffffff;
        border: 1px solid #374151;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s;
        margin-top: 2rem;
    }

    .btn-back:hover {
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(31, 41, 55, 0.4);
    }

    .loading {
        text-align: center;
        padding: 4rem;
        color: #6b7280;
        font-size: 1rem;
    }

    .error-message {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
        color: #ef4444;
        padding: 1.5rem;
        border: 1px solid #ef4444;
        border-radius: 12px;
        font-weight: 500;
        text-align: center;
    }

    @media (max-width: 968px) {
        .track-content {
            grid-template-columns: 1fr;
        }

        h1 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<main>
    <div class="container">
        <h1>Track Your Order</h1>
        <p class="order-id-subtitle" id="orderIdSubtitle">Loading order details...</p>

        <div id="trackContent" class="track-content">
            <div class="loading">Loading tracking information...</div>
        </div>

        <a href="{% url 'orders' %}" class="btn-back">← Back to Orders</a>
    </div>
</main>
{% endblock %}

{% block js %}
<script>
    const API_BASE_URL = 'http://localhost:8000/';

    // Sample tracking data
    const sampleTrackingData = {
        1001: {
            id: 1001,
            status: 'delivered',
            created_at: '2025-10-15',
            total: 850,
            items: [
                { product_name: 'Fresh Organic Apples (1kg)', quantity: 2, price: 120 },
                { product_name: 'Basmati Rice (5kg)', quantity: 1, price: 450 },
                { product_name: 'Fresh Milk (1L)', quantity: 3, price: 60 }
            ],
            delivery_address: {
                name: 'Rajesh Kumar',
                phone: '+91 98765 43210',
                address: '123, MG Road, Koramangala',
                city: 'Bangalore',
                state: 'Karnataka',
                pincode: '560034'
            },
            tracking: [
                { status: 'Order Placed', date: '2025-10-15 10:30 AM', description: 'Your order has been placed successfully', completed: true },
                { status: 'Processing', date: '2025-10-15 11:45 AM', description: 'Your order is being prepared', completed: true },
                { status: 'Shipped', date: '2025-10-15 02:30 PM', description: 'Your order has been shipped', completed: true },
                { status: 'Out for Delivery', date: '2025-10-15 08:00 AM', description: 'Your order is out for delivery', completed: true },
                { status: 'Delivered', date: '2025-10-15 11:30 AM', description: 'Your order has been delivered', completed: true }
            ]
        },
        1002: {
            id: 1002,
            status: 'delivered',
            created_at: '2025-10-10',
            total: 1250,
            items: [
                { product_name: 'Mixed Vegetables (2kg)', quantity: 1, price: 180 },
                { product_name: 'Whole Wheat Flour (10kg)', quantity: 1, price: 550 },
                { product_name: 'Fresh Paneer (500g)', quantity: 2, price: 260 }
            ],
            delivery_address: {
                name: 'Priya Sharma',
                phone: '+91 98765 43211',
                address: '456, Brigade Road, Indiranagar',
                city: 'Bangalore',
                state: 'Karnataka',
                pincode: '560038'
            },
            tracking: [
                { status: 'Order Placed', date: '2025-10-10 09:15 AM', description: 'Your order has been placed successfully', completed: true },
                { status: 'Processing', date: '2025-10-10 10:30 AM', description: 'Your order is being prepared', completed: true },
                { status: 'Shipped', date: '2025-10-10 01:00 PM', description: 'Your order has been shipped', completed: true },
                { status: 'Out for Delivery', date: '2025-10-11 07:30 AM', description: 'Your order is out for delivery', completed: true },
                { status: 'Delivered', date: '2025-10-11 10:15 AM', description: 'Your order has been delivered', completed: true }
            ]
        },
        1003: {
            id: 1003,
            status: 'shipped',
            created_at: '2025-10-05',
            total: 680,
            items: [
                { product_name: 'Organic Honey (500g)', quantity: 1, price: 350 },
                { product_name: 'Green Tea (100g)', quantity: 2, price: 165 }
            ],
            delivery_address: {
                name: 'Amit Patel',
                phone: '+91 98765 43212',
                address: '789, Whitefield Main Road',
                city: 'Bangalore',
                state: 'Karnataka',
                pincode: '560066'
            },
            tracking: [
                { status: 'Order Placed', date: '2025-10-05 03:20 PM', description: 'Your order has been placed successfully', completed: true },
                { status: 'Processing', date: '2025-10-05 04:45 PM', description: 'Your order is being prepared', completed: true },
                { status: 'Shipped', date: '2025-10-06 09:00 AM', description: 'Your order has been shipped', completed: true },
                { status: 'Out for Delivery', date: '', description: 'Your order will be out for delivery soon', completed: false },
                { status: 'Delivered', date: '', description: 'Your order will be delivered', completed: false }
            ]
        }
    };

    function getLocalCart() {
        const cart = localStorage.getItem('cart');
        return cart ? JSON.parse(cart) : [];
    }

    function updateCartCount() {
        const cart = getLocalCart();
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.querySelectorAll('.cart-count').forEach((el) => {
            el.textContent = totalItems;
        });
    }

    function getOrderIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateCartCount();
        setupMobileNav();
        loadTrackingInfo();
    });

    function setupMobileNav() {
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');

        if (navToggle && navMenu) {
            navToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
        }
    }

    function loadTrackingInfo() {
        const orderId = getOrderIdFromUrl();
        const orderIdSubtitle = document.getElementById('orderIdSubtitle');
        const trackContent = document.getElementById('trackContent');

        if (!orderId) {
            trackContent.innerHTML = '<div class="error-message">No order ID provided. Please select an order to track.</div>';
            orderIdSubtitle.textContent = 'Error';
            return;
        }

        orderIdSubtitle.textContent = `Order #${orderId}`;

        // Get tracking data (using sample data for now)
        const trackingData = sampleTrackingData[orderId];

        if (!trackingData) {
            trackContent.innerHTML = '<div class="error-message">Order not found. Please check your order ID.</div>';
            return;
        }

        displayTrackingInfo(trackingData);
    }

    function displayTrackingInfo(data) {
        const trackContent = document.getElementById('trackContent');

        // Find the current active step
        let activeIndex = -1;
        for (let i = 0; i < data.tracking.length; i++) {
            if (data.tracking[i].completed && (i === data.tracking.length - 1 || !data.tracking[i + 1].completed)) {
                activeIndex = i;
                break;
            }
        }

        const timelineHTML = `
            <div class="track-card">
                <h2>Order Status</h2>
                <div class="timeline">
                    ${data.tracking.map((item, index) => `
                        <div class="timeline-item ${item.completed ? 'completed' : ''} ${index === activeIndex + 1 && !item.completed ? 'active' : ''}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">${item.status}</div>
                                ${item.date ? `<div class="timeline-date">${item.date}</div>` : ''}
                                <div class="timeline-description">${item.description}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        const detailsHTML = `
            <div class="track-card">
                <h2>Order Details</h2>
                <div class="detail-row">
                    <span class="detail-label">Order ID</span>
                    <span class="detail-value">#${data.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Order Date</span>
                    <span class="detail-value">${formatDate(data.created_at)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span class="detail-value" style="color: #10b981; text-transform: capitalize;">${data.status}</span>
                </div>

                <div class="order-items-list">
                    <h3 style="color: #10b981; font-size: 1.125rem; margin-bottom: 1rem;">Items</h3>
                    ${data.items.map(item => `
                        <div class="order-item">
                            <span>${item.product_name} × ${item.quantity}</span>
                            <span>₹${(parseFloat(item.price) * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="order-total">
                        <span>Total</span>
                        <span>₹${parseFloat(data.total).toFixed(2)}</span>
                    </div>
                </div>

                <div class="delivery-info">
                    <h3>Delivery Address</h3>
                    <p><strong>${data.delivery_address.name}</strong></p>
                    <p>${data.delivery_address.phone}</p>
                    <p>${data.delivery_address.address}</p>
                    <p>${data.delivery_address.city}, ${data.delivery_address.state} - ${data.delivery_address.pincode}</p>
                </div>
            </div>
        `;

        trackContent.innerHTML = timelineHTML + detailsHTML;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
    }
</script>
{% endblock %}
