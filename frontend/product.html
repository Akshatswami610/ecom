{% extends 'basic.html' %}
{% block title %}FreshMart India - Product Details{% endblock %}

{% block css %}
<style>
    .back-link {
        display: inline-block;
        margin: 2rem 0;
        color: #10b981;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .back-link:hover {
        color: #059669;
        transform: translateX(-4px);
    }

    main {
        padding: 0 0 4rem 0;
        min-height: calc(100vh - 200px);
    }

    .product-detail {
        background: linear-gradient(135deg, #111111 0%, #0a0a0a 100%);
        border: 1px solid #1f2937;
        border-radius: 16px;
        padding: 3rem;
        margin-bottom: 3rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .product-detail-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4rem;
    }

    .product-image-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        border: 1px solid #1f2937;
    }

    .product-detail-image {
        width: 100%;
        border-radius: 12px;
        transition: transform 0.5s ease;
    }

    .product-image-wrapper:hover .product-detail-image {
        transform: scale(1.05);
    }

    .product-detail-info h1 {
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #ffffff;
        animation: fadeIn 0.7s ease 0.2s both;
    }

    .product-badge {
        display: inline-block;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        animation: scaleIn 0.5s ease 0.3s both;
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    .product-detail-price {
        font-size: 2.5rem;
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        margin-bottom: 2rem;
        animation: fadeIn 0.7s ease 0.4s both;
    }

    .product-detail-description {
        color: #9ca3af;
        margin-bottom: 2rem;
        line-height: 1.8;
        font-size: 1rem;
        animation: fadeIn 0.7s ease 0.5s both;
    }

    .variant-selector {
        margin-bottom: 2rem;
        animation: fadeIn 0.7s ease 0.5s both;
    }

    .variant-selector label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #d1d5db;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .variant-options {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .variant-option {
        padding: 0.75rem 1.25rem;
        border: 2px solid #1f2937;
        background-color: #111111;
        color: #9ca3af;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .variant-option:hover {
        border-color: #10b981;
        background-color: rgba(16, 185, 129, 0.1);
    }

    .variant-option.selected {
        border-color: #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
        color: #10b981;
    }

    .variant-option-name {
        font-weight: 600;
    }

    .variant-option-price {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .variant-option.selected .variant-option-price {
        color: #34d399;
    }

    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        animation: fadeIn 0.7s ease 0.6s both;
    }

    .quantity-selector label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #d1d5db;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 0;
        border: 2px solid #1f2937;
        border-radius: 8px;
        overflow: hidden;
        background-color: #111111;
    }

    .qty-btn {
        width: 40px;
        height: 40px;
        border: none;
        background-color: #1f2937;
        color: #10b981;
        font-size: 1.25rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qty-btn:hover {
        background-color: #10b981;
        color: #ffffff;
    }

    .qty-btn:active {
        transform: scale(0.95);
    }

    .quantity-controls input {
        width: 60px;
        padding: 0.75rem;
        border: none;
        border-left: 1px solid #1f2937;
        border-right: 1px solid #1f2937;
        background-color: #111111;
        color: #ffffff;
        text-align: center;
        font-size: 1rem;
        font-weight: 600;
    }

    .quantity-controls input:focus {
        outline: none;
    }

    .btn {
        padding: 1rem 2.5rem;
        border: none;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        animation: fadeIn 0.7s ease 0.7s both;
    }

    .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .loading {
        text-align: center;
        padding: 4rem;
        color: #6b7280;
        font-size: 1rem;
    }

    .error-message {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
        color: #ef4444;
        padding: 1rem 1.5rem;
        border: 1px solid #ef4444;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
    }

    .success-message {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
        color: #10b981;
        padding: 1rem 1.5rem;
        border: 1px solid #10b981;
        border-radius: 8px;
        font-weight: 500;
    }

    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #ffffff;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .product-detail-content {
            grid-template-columns: 1fr;
        }

        .product-detail {
            padding: 2rem;
        }

        .product-detail-info h1 {
            font-size: 2rem;
        }

        .product-detail-price {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<main>
    <div class="container">
        <a href="{% url 'home' %}" class="back-link">← Back to Home</a>

        <div id="productDetail" class="product-detail">
            <div class="loading">Loading product details...</div>
        </div>
    </div>
</main>
{% endblock %}

{% block js %}
<script>
    const API_BASE_URL = 'http://localhost:8000/api/v1/';

    // Helper functions
    function getToken() {
        return localStorage.getItem('authToken') || localStorage.getItem('token');
    }

    function isAuthenticated() {
        return !!getToken();
    }

    function getLocalCart() {
        const cart = localStorage.getItem('cart');
        return cart ? JSON.parse(cart) : [];
    }

    function saveLocalCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
    }

    function updateCartCount() {
        const cart = getLocalCart();
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.querySelectorAll('.cart-count').forEach((el) => {
            el.textContent = totalItems;
        });
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = type === 'success' ? 'success-message' : 'error-message';
        notification.textContent = message;
        notification.style.position = 'fixed';
        notification.style.top = '100px';
        notification.style.right = '2rem';
        notification.style.zIndex = '9999';
        notification.style.padding = '1rem 1.5rem';
        notification.style.fontSize = '0.875rem';
        notification.style.letterSpacing = '0.05em';

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // API functions - Using same approach as cart.html
    const API = {
        async getProduct(id) {
            try {
                const response = await fetch(`${API_BASE_URL}Product/${id}/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        },

        async addToCart(productId, quantity = 1, variant = '100g') {
            const token = getToken();

            if (!token) {
                throw new Error('Not authenticated');
            }

            // ✅ FIXED: Use standard POST endpoint like cart.html does
            const body = {
                product_id: productId,
                quantity: quantity,
                variant: variant
            };

            console.log('Adding to cart with body:', body);

            // Use standard POST endpoint (not add_item)
            const response = await fetch(`${API_BASE_URL}Cart/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('Cart API error:', errorData);
                throw new Error(errorData.error || `Failed to add to cart: ${response.status}`);
            }

            return await response.json();
        },

        async getCart() {
            const token = getToken();

            if (!token) {
                throw new Error('Not authenticated');
            }

            const response = await fetch(`${API_BASE_URL}Cart/`, {
                headers: {
                    'Authorization': `Token ${token}`
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch cart: ${response.status}`);
            }

            return await response.json();
        },

        async updateCartItem(cartItemId, quantity) {
            const token = getToken();

            if (!token) {
                throw new Error('Not authenticated');
            }

            const response = await fetch(`${API_BASE_URL}Cart/${cartItemId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`
                },
                body: JSON.stringify({ quantity: quantity })
            });

            if (!response.ok) {
                throw new Error(`Failed to update cart: ${response.status}`);
            }

            return await response.json();
        }
    };

    let currentProduct = null;
    let selectedVariant = null;

    document.addEventListener('DOMContentLoaded', async () => {
        updateCartCount();
        setupMobileNav();

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (productId) {
            await loadProduct(productId);
        } else {
            document.getElementById('productDetail').innerHTML =
                '<div class="error-message">No product ID provided.</div>';
        }
    });

    function setupMobileNav() {
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');

        if (navToggle && navMenu) {
            navToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
        }
    }

    async function loadProduct(productId) {
        const productDetail = document.getElementById('productDetail');

        try {
            currentProduct = await API.getProduct(productId);
            displayProduct(currentProduct);
        } catch (error) {
            console.error('Error loading product:', error);
            productDetail.innerHTML =
                '<div class="error-message">Failed to load product. Please try again later.</div>';
        }
    }

    function displayProduct(product) {
        const productDetail = document.getElementById('productDetail');

        // Parse product price data
        let variants = [];
        try {
            if (product.product_price_data) {
                const priceData = typeof product.product_price_data === 'string'
                    ? JSON.parse(product.product_price_data)
                    : product.product_price_data;

                variants = Object.entries(priceData).map(([name, price]) => ({
                    name,
                    price: parseFloat(price)
                }));
            }
        } catch (error) {
            console.error('Error parsing price data:', error);
        }

        // Set initial selected variant
        if (variants.length > 0) {
            selectedVariant = variants[0];
        }

        const displayPrice = selectedVariant ? selectedVariant.price : product.product_mrp;
        const displayVariant = selectedVariant ? selectedVariant.name : product.product_variant;

        productDetail.innerHTML = `
            <div class="product-detail-content">
                <div class="product-image-wrapper">
                    <img src="${product.product_image || '/placeholder.svg?height=600&width=600'}"
                         alt="${product.product_name}"
                         class="product-detail-image">
                </div>
                <div class="product-detail-info">
                    <h1>${product.product_name}</h1>
                    <div class="product-badge">Fresh</div>
                    <div class="product-detail-price" id="displayPrice">₹${parseFloat(displayPrice).toFixed(2)} <span style="font-size: 1rem; color: #9ca3af;">/${displayVariant}</span></div>
                    <p class="product-detail-description">${product.product_desc || 'Premium quality product crafted with attention to detail'}</p>

                    ${variants.length > 0 ? `
                    <div class="variant-selector">
                        <label>Select Variant</label>
                        <div class="variant-options" id="variantOptions">
                            ${variants.map((variant, index) => `
                                <div class="variant-option ${index === 0 ? 'selected' : ''}"
                                     onclick="selectVariant('${variant.name}', ${variant.price})">
                                    <span class="variant-option-name">${variant.name}</span>
                                    <span class="variant-option-price">₹${variant.price.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="quantity-selector">
                        <label>Quantity</label>
                        <div class="quantity-controls">
                            <button class="qty-btn" onclick="decrementQty()">−</button>
                            <input type="number" id="quantity" value="1" min="1" max="99" readonly>
                            <button class="qty-btn" onclick="incrementQty()">+</button>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="addToCartBtn" onclick="addProductToCart()">Add to Cart</button>
                </div>
            </div>
        `;
    }

    function selectVariant(variantName, variantPrice) {
        selectedVariant = { name: variantName, price: variantPrice };

        // Update UI
        const displayPrice = document.getElementById('displayPrice');
        displayPrice.innerHTML = `₹${variantPrice.toFixed(2)} <span style="font-size: 1rem; color: #9ca3af;">/${variantName}</span>`;

        // Update selected state
        document.querySelectorAll('.variant-option').forEach(option => {
            option.classList.remove('selected');
        });
        event.target.closest('.variant-option').classList.add('selected');
    }

    function incrementQty() {
        const qtyInput = document.getElementById('quantity');
        let currentValue = parseInt(qtyInput.value);
        if (currentValue < 99) {
            qtyInput.value = currentValue + 1;
        }
    }

    function decrementQty() {
        const qtyInput = document.getElementById('quantity');
        let currentValue = parseInt(qtyInput.value);
        if (currentValue > 1) {
            qtyInput.value = currentValue - 1;
        }
    }

    async function addProductToCart() {
        const quantity = parseInt(document.getElementById('quantity').value);
        const addToCartBtn = document.getElementById('addToCartBtn');

        if (!currentProduct) {
            showNotification('Product not loaded. Please refresh the page.', 'error');
            return;
        }

        if (quantity < 1) {
            showNotification('Please enter a valid quantity.', 'error');
            return;
        }

        // Check if user is authenticated
        if (!isAuthenticated()) {
            showNotification('Please login to add items to cart', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1500);
            return;
        }

        // Disable button and show loading state
        addToCartBtn.disabled = true;
        const originalText = addToCartBtn.innerHTML;
        addToCartBtn.innerHTML = '<span class="loading-spinner"></span> Adding...';

        try {
            // Get variant name correctly
            const variantName = selectedVariant
                ? selectedVariant.name
                : (currentProduct.product_variant ?
                    (Array.isArray(currentProduct.product_variant) ? currentProduct.product_variant[0] : currentProduct.product_variant)
                    : '100g');

            console.log('Adding to cart:', {
                productId: currentProduct.id,
                quantity: quantity,
                variant: variantName
            });

            // Check if item already exists in cart (same product + variant)
            const cartData = await API.getCart();
            let items = [];

            if (cartData && cartData.items && Array.isArray(cartData.items)) {
                items = cartData.items;
            } else if (Array.isArray(cartData)) {
                items = cartData;
            }

            const existingItem = items.find(item =>
                (item.product?.id || item.product_id) === currentProduct.id &&
                item.variant === variantName
            );

            if (existingItem) {
                // Update existing item quantity
                const newQuantity = (existingItem.quantity || existingItem.qty || 0) + quantity;
                await API.updateCartItem(existingItem.id, newQuantity);
                console.log('Updated existing cart item');
            } else {
                // Add new item to cart
                await API.addToCart(currentProduct.id, quantity, variantName);
                console.log('Added new item to cart');
            }

            // Sync local cart with backend
            try {
                const updatedCartData = await API.getCart();
                let updatedItems = [];

                if (updatedCartData && updatedCartData.items && Array.isArray(updatedCartData.items)) {
                    updatedItems = updatedCartData.items;
                } else if (Array.isArray(updatedCartData)) {
                    updatedItems = updatedCartData;
                }

                if (updatedItems.length > 0) {
                    const backendCart = updatedItems.map(item => ({
                        id: item.product?.id || item.product_id || item.id,
                        cartItemId: item.id,
                        name: item.product?.name || item.product?.product_name || item.name,
                        price: item.product?.price || item.price,
                        image: item.product?.image || item.product?.product_image || item.image,
                        quantity: item.quantity || item.qty || 1,
                        variant: item.variant || '100g'
                    }));
                    saveLocalCart(backendCart);
                }
            } catch (syncError) {
                console.error('Failed to sync cart after adding:', syncError);
            }

            showNotification('Product added to cart successfully!', 'success');

            // Reset quantity to 1
            document.getElementById('quantity').value = 1;

        } catch (error) {
            console.error('Failed to add to cart:', error);

            // Specific error messages
            if (error.message.includes('Not authenticated')) {
                showNotification('Please login to add items to cart', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
            } else if (error.message.includes('500')) {
                showNotification('Server error. Please try again later.', 'error');
            } else if (error.message.includes('401') || error.message.includes('403')) {
                showNotification('Authentication failed. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else if (error.message.includes('Product not found')) {
                showNotification('Product not found. Please try another product.', 'error');
            } else {
                showNotification(error.message || 'Failed to add product to cart. Please try again.', 'error');
            }
        } finally {
            // Re-enable button
            addToCartBtn.disabled = false;
            addToCartBtn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}